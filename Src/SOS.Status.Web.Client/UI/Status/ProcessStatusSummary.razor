@using SOS.Status.Web.Client.Dtos
@using SOS.Status.Web.Client.Helpers
<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
    @if (ProcessSummary?.ActiveProcessStatus != null)
    {
        <MudText Typo="Typo.body2">@DateTime.Now.ToString("yyyy-MM-dd HH:mm")</MudText>        
        <MudText>|</MudText>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@GetProcessStatusCircleStyle(ProcessSummary.ActiveProcessStatus.Status)" />
            <MudText Typo="Typo.body2">@ProcessSummary.ActiveProcessStatus.Name (active)</MudText>
            <MudText Typo="Typo.body2"><b>(@DateTimeHelper.GetTimeAgo(DateTime.UtcNow - ProcessSummary.ActiveProcessStatus.End))</b></MudText>
        </MudStack>
        <MudText>|</MudText>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@GetProcessStatusCircleStyle(ProcessSummary.InactiveProcessStatus.Status)" />
            <MudText Typo="Typo.body2">@ProcessSummary.InactiveProcessStatus.Name</MudText>
            <MudText Typo="Typo.body2"><b>(@DateTimeHelper.GetTimeAgo(DateTime.UtcNow - ProcessSummary.InactiveProcessStatus.End))</b></MudText>
        </MudStack>        
        @if (artportalenIncrementalIsActive)
        {
            <MudText>|</MudText>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body2">Artportalen incremental count: @artportalenLastIncrementalText</MudText>
                <MudText Typo="Typo.body2"><b>(@artportalenMinutesAgoText)</b></MudText>
            </MudStack>
        }        
    }
</MudStack>

@code {
    [Parameter]
    public ProcessSummaryDto? ProcessSummary { get; set; }
    private string? artportalenLastIncrementalText;
    private string? artportalenMinutesAgoText;
    private bool artportalenIncrementalIsActive = false;

    protected override void OnParametersSet()
    {
        if (ProcessSummary == null)
        {
            artportalenLastIncrementalText = null;
            artportalenMinutesAgoText = null;
            return;
        }

        var artportalenStatus = ProcessSummary.DataProviderStatuses.Single(m => m.Id == 1);
        int? incrementalPublic = artportalenStatus.LatestIncrementalPublicCount;
        int? incrementalProtected = artportalenStatus.LatestIncrementalProtectedCount;
        artportalenLastIncrementalText = (incrementalPublic.GetValueOrDefault() + incrementalProtected.GetValueOrDefault()).ToString("N0");
        artportalenMinutesAgoText = DateTimeHelper.GetTimeAgo(artportalenStatus.LatestIncrementalEnd);
        artportalenIncrementalIsActive = !string.IsNullOrEmpty(artportalenMinutesAgoText);
    }

    private string GetArtportalenLastIncrementalText()
    {
        if (ProcessSummary == null) return "";

        var artportalenStatus = ProcessSummary.DataProviderStatuses.Single(m => m.Id == 1);
        int? incrementalPublic = artportalenStatus.LatestIncrementalPublicCount;
        int? incrementalProtected = artportalenStatus.LatestIncrementalProtectedCount;
        TimeSpan? incrementalProcessTime = artportalenStatus.LatestIncrementalTime;
        DateTime? incrementalLastHarvest = artportalenStatus.LatestIncrementalEnd;

        return (incrementalPublic.GetValueOrDefault() + incrementalProtected.GetValueOrDefault()).ToString("N0");
    }

    private string GetArtportalenMinutesAgoText()
    {
        if (ProcessSummary == null) return "";

        var artportalenStatus = ProcessSummary.DataProviderStatuses.Single(m => m.Id == 1);        
        TimeSpan? incrementalProcessTime = artportalenStatus.LatestIncrementalTime;
        DateTime? incrementalLastHarvest = artportalenStatus.LatestIncrementalEnd;

        return DateTimeHelper.GetTimeAgo(incrementalLastHarvest);
    }   

    private string GetProcessStatusCircleStyle(string status)
    {
        if (status.Equals("success", StringComparison.InvariantCultureIgnoreCase))
            return "color:green; font-size:18px;";
        else
            return "color:red; font-size:18px;";
    }
}