@page "/statuswithoutinactive"
@using System.Diagnostics
@using SOS.Status.Web.Client.Abstractions
@inject IStatusInfoService statusInfoService;

<PageTitle>Status info</PageTitle>
<MudText Typo="Typo.h4">Status info</MudText>
@if (processSummary is null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <ProcessStatusSummary ProcessSummary="@processSummary" />
    <MudDivider Class="my-2" />
    <MudTabs Outlined="true">
        <MudTabPanel Text="Datasets" Icon="@Icons.Material.Filled.Storage">
            <DataProviderGrid2 ProcessSummary="@processSummary" />        
        </MudTabPanel>
        <MudTabPanel Text="Indices" Icon="@Icons.Material.Outlined.Dataset"> @* ViewList *@
            <MudTabs Outlined="true">
                <MudTabPanel Text="@($"{processSummary.ActiveProcessStatus.Name} (Active)")">
                    <DataProviderIndexStatus ProcessStatus="@processSummary.ActiveProcessStatus" DataProviderStatuses="@processSummary.DataProviderStatuses" ActiveInstance="true" />
                </MudTabPanel>
                <MudTabPanel Text="@processSummary.InactiveProcessStatus.Name">
                    <DataProviderIndexStatus ProcessStatus="@processSummary.InactiveProcessStatus" DataProviderStatuses="@processSummary.DataProviderStatuses" ActiveInstance="false" />
                </MudTabPanel>
            </MudTabs>
        </MudTabPanel>
        <MudTabPanel Text="Tests" Icon="@Icons.Material.Outlined.Science" BadgeDot="true" BadgeColor="@testsTabBadgeColor">
            <HealthReportsSummary 
                ObservationApiHealthReport="@observationsApiHealthReport" 
                AnalysisApiHealthReport="@analysisApiHealthReport" 
                ElasticsearchProxyHealthReport="@elasticsearchProxyHealthReport"
                DataStewardshipApiHealthReport="@dataStewardshipApiHealthReport" />
        </MudTabPanel>
        <MudTabPanel Text="Markdown" Icon="@Icons.Material.Outlined.Science">
            <MudMarkdown Value="@Value" />
        </MudTabPanel>        
    </MudTabs>
}

@code {
    private ProcessSummaryDto? processSummary;
    private HealthReportDto? observationsApiHealthReport;
    private HealthReportDto? analysisApiHealthReport;
    private HealthReportDto? elasticsearchProxyHealthReport;
    private HealthReportDto? dataStewardshipApiHealthReport;
    private Color testsTabBadgeColor;
    private string Value { get; } = "text *italics* and **bold**\r\n# Heading1\r\nText\r\n### Heading3\r\n- Test";  
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            Stopwatch sp = Stopwatch.StartNew();

            // Get what we need for the initial tab
            processSummary = await statusInfoService.GetProcessSummaryAsync();

            // Starta bakgrundshämtning för Tests-tabben
            _ = LoadTestsTabDataAsync();

            sp.Stop();
            Console.WriteLine($"Initial load in {sp.ElapsedMilliseconds} ms");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching process information: {ex.Message}");
        }
    }

    private async Task LoadTestsTabDataAsync()
    {        
        var fetchObservationsTask = statusInfoService.GetObservationsApiHealthAsync()
            .ContinueWith(t => observationsApiHealthReport = t.Result);

        var fetchAnalysisTask = statusInfoService.GetAnalysisApiHealthAsync()
            .ContinueWith(t => analysisApiHealthReport = t.Result);

        var fetchElasticsearchTask = statusInfoService.GetElasticsearchProxyHealthAsync()
            .ContinueWith(t => elasticsearchProxyHealthReport = t.Result);

        var fetchDataStewardshipTask = statusInfoService.GetDataStewardshipApiHealthAsync()
            .ContinueWith(t => dataStewardshipApiHealthReport = t.Result);
        
        await Task.WhenAll(fetchObservationsTask, fetchAnalysisTask, fetchElasticsearchTask, fetchDataStewardshipTask);

        testsTabBadgeColor = ColorHelper.GetHealthColor(
            observationsApiHealthReport?.Status,
            analysisApiHealthReport?.Status,
            elasticsearchProxyHealthReport?.Status,
            dataStewardshipApiHealthReport?.Status
        );
        
        await InvokeAsync(StateHasChanged);
    }

}